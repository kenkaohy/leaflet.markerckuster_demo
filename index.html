<!DOCTYPE html>
<html>

<head>
    <title>Leaflet debug page</title>
    <meta charset="utf-8" />
    <!--jquery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <!--leaflet-->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="screen.css" />
    <!--markercluster-->
    <link rel="stylesheet" href="./dist/MarkerCluster.css" />
    <link rel="stylesheet" href="./dist/MarkerCluster.Default.css" />
    <script src="./dist/leaflet.markercluster-src.js"></script>
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--moment-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
    <!--bootstrap-datetimepicker-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <!--leaflet.featuregroup.subgroup-->
    <!--<script src="https://raw.githubusercontent.com/ghybs/Leaflet.FeatureGroup.SubGroup/master/leaflet.featuregroup.subgroup-src.js"></script>-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="mapbox effect6 col-xs-12">
                <!--map cpntrol panel-->
                <div id="map-panel">
                    <div class="center-block">                        
                      <form class="form-inline" role="form">
                            <!--<div class="form-group   margin-left">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" checked="checked" id="cb1">&#32;All patients
                                    </label>
                                </div>                             
                            </div>-->
                            <div class="form-group margin-left">
                                <select class="form-control" id='opts'>
                                <option selected value="all">All Patients</option>
                                <option value="dis">Discharge in</option>
                                </select>                            
                            </div>                            
                             
                            <div class="form-group">
                                <div class='input-group date' id='datepickerfrom'>
                                    <input type='text' class="form-control" id='inputfrom' placeholder="Admin date from" />
                                    <span class="input-group-addon">
                                         <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class='input-group date' id='datepickerto'>
                                    <input type='text' class="form-control" id='inputto' placeholder="Admin date to" />
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                </div>
                            </div>
                            <!--<button type="submit" class="btn btn-primary btn-sm">Search</button>-->
                            <button type="button" class="btn btn-primary btn-sm" id='btnfilter'>Refine</button>
                        </form>
                    </div>

                </div>
                <!--map body-->
                <div id="map">
                    <div id="progress">
                        <div id="progress-bar"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript">
        var progress = document.getElementById('progress');
		var progressBar = document.getElementById('progress-bar');
        var addressPoints = {};
		var markers = L.markerClusterGroup({ chunkedLoading: true, chunkProgress: updateProgressBar });
		var markerList= [];//geodata  
        var filterList= [];//geodata
        var disList= [];//geodata  
        var from, to;
	    // var parent = L.featureGroup();
        //    groupIn = L.featureGroup.subGroup(parent),
		//    groupOut = L.featureGroup.subGroup(parent);
              
        $.ajax({
            url: 'https://raw.githubusercontent.com/kenkaohy/json/master/PATIENT_GEO.json',
            //url: '@Url.HttpRouteUrl("API Default", new { httproute = "", controller = "PATIENT_GEO", action = "GetCoordinates" })/',
            type: 'GET',
            dataType: 'json',
            data: {format: 'json'},
            success: function(geodata) {
                addressPoints = geodata;
                //console.log(addressPoints);
            }
        }).done(function(){
            var len = addressPoints.length;
            for ( i = 0; i < len; i++) {
                    var a = addressPoints[i];
                    var title = a['ADMITDATE'];
                    var status = a['STATUS']
                    var marker = L.marker(L.latLng(a['latitude'], a['longitude']), { title: title });
                    marker.bindPopup(title);
                    markerList.push(marker);
                    //create sub list filter by status
                    if (status == 'DIS IN'){
                        var dis = L.marker(L.latLng(a['latitude'], a['longitude']), { title: title });
                        dis.bindPopup(title);
                        disList.push(dis);                        
                    }
		      }  
            markers.addLayers(markerList);         
		    //map.addLayer(markers);
        });
            
        //initial map layers
		var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>'
        }),latlng = L.latLng(43.7104876,-79.5032786);
        var Esri_WorldStreetMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
        }),latlng = L.latLng(43.7104876,-79.5032786);        
        var grayscale = L.tileLayer('http://korona.geog.uni-heidelberg.de/tiles/roadsg/x={x}&y={y}&z={z}', {
            attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group at University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }),latlng = L.latLng(43.7104876,-79.5032786);
                                        
        //control manu: layer options
        var baseMaps = {
            "Grayscale": grayscale,
            "Esri": Esri_WorldStreetMap,
            "OSM": osm
        };
        //control manu: markers options
		var overlayMaps = {
			"markers": markers
		};
        //intial map options
		var map = L.map('map', { 
            center: latlng, 
            minZoom: 6,
            maxZoom: 14,
            zoom: 11, 
            layers: [osm, markers]
        });        
        //Create layer control       
        L.control.layers(baseMaps, overlayMaps).addTo(map);

        //progress bar
		function updateProgressBar(processed, total, elapsed, layersArray) {
			if (elapsed > 1000) {
				// if it takes more than a second to load, display the progress bar:
				progress.style.display = 'block';
				progressBar.style.width = Math.round(processed/total*100) + '%';
			}
			if (processed === total) {
				// all markers processed - hide the progress bar:
				progress.style.display = 'none';
			}
		}
        
        //bind filter button
        $(function(){
            $("#btnfilter").on("click", function() {
                filterList=[];//reset
               
                //apply select option
                if ( $( "#opts option:selected" ).val()=='all' ){
                     filterList=markerList;
                     console.log('markerList');
                     console.log(markerList.length);
                }else{
                    filterList=disList;
                    console.log('disList');
                    console.log(disList.length);
                }
                console.log(filterList);
                //apply date range
                if (from != 'undefined' || to != 'undefined'){
                    //console.log('admin date from:' + from );
                    //console.log('admin date to:' + to);        
                    var l =  filterList.length;
                    var compareDate, tit;
                    var startDate = moment(from, "DD/MM/YYYY");
                    var endDate = moment(to, "DD/MM/YYYY");                    
                    var p;
                    for ( i = 0; i < l; i++) {
                        p = filterList[i];
                        compareDate = p['_popup']['_content'];
                        if (compareDate!= null){
                            compareDate = moment(compareDate , "DD/MM/YYYY");
                            if (compareDate.isBetween(startDate, endDate)){
                                tit = compareDate;
                                var marker = L.marker(L.latLng(p['_latlng']['lat'], p['_latlng']['lng']), { title: tit });
                                marker.bindPopup(tit);
                                filterList.push(marker);
                            }   
                        }
                    } //end for                                
                }                
                //console.log('count after: ' + filterList.length);
                markers.clearLayers();
                markers.addLayers(filterList);                  
            });            
        });
        
        
        //datepicker initialization 
        $(function () {
            $('#datepickerfrom').datetimepicker({
                format: 'MM/DD/YYYY'
            });
            $('#datepickerto').datetimepicker({
                format: 'MM/DD/YYYY',
                useCurrent: false //Important! See issue #1075
            });
            $("#datepickerfrom").on("dp.change", function (e) {
                $('#datepickerto').data("DateTimePicker").minDate(e.date);
                from=e.date;
            });
            $("#datepickerto").on("dp.change", function (e) {
                $('#datepickerfrom').data("DateTimePicker").maxDate(e.date);
                to=e.date;
            });
        });
   
        //input constrain
        // $(function () {
        //     uncheck the checkbox when the date been selected
        //     $('#inputfrom, #inputto').blur(function(e) {
        //         if ( $(this).val() != "" ){
        //           $('#cb1').prop('checked', $(this).prop("checked"));
        //         }
        //     });
        //     clear datapickers when box checked          
        //     $('#cb1').on('click', function(e) {
        //         if ( $('#cb1').is( ":checked" ) ){
        //             $('#inputfrom, #inputto').val('');
        //         }
        //     });
        //     $('#opts').change(function(){
        //         var selected= $(this).val();
        //         if ( selected='all' ){
                     
        //         }                
                
        //         console.log(data);           
        //     });          
        // });
    </script>
</body>

</html>